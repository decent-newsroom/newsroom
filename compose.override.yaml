# =============================================================================
# Development Environment Override
# =============================================================================
#
# This file is automatically loaded by Docker Compose when running:
#   docker compose up -d
#
# It adds development-specific features:
#   - Source code bind mounts (live reload)
#   - Xdebug support
#   - Development PHP settings
#   - Redis service (included locally, may be external in production)
#   - Exposed database port
#
# DO NOT use this file in production! Use compose.prod.yaml instead.
# =============================================================================

# Development environment override
services:
  php:
    image: newsroom-php
    build:
      context: .
      target: frankenphp_dev
    volumes:
      - ./:/app
      - ./frankenphp/Caddyfile:/etc/frankenphp/Caddyfile:ro
      - ./frankenphp/conf.d/20-app.dev.ini:/usr/local/etc/php/app.conf.d/20-app.dev.ini:ro
      # If you develop on Mac or Windows you can remove the vendor/ directory
      #  from the bind-mount for better performance by enabling the next line:
      - /app/vendor
    environment:
      MERCURE_EXTRA_DIRECTIVES: demo
      # See https://xdebug.org/docs/all_settings#mode
      XDEBUG_MODE: "${XDEBUG_MODE:-off}"
    extra_hosts:
      # Ensure that host.docker.internal is correctly defined on Linux
      - host.docker.internal:host-gateway
    tty: true

###> symfony/mercure-bundle ###
###< symfony/mercure-bundle ###

###> doctrine/doctrine-bundle ###
  database:
    restart: always
    ports:
      - "5432"
###< doctrine/doctrine-bundle ###

###> Redis (local development) ###
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-r_password}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-r_password}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
###< Redis ###

  worker:
    environment:
      APP_ENV: prod
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-r_password}
      MESSENGER_TRANSPORT_DSN: ${MESSENGER_TRANSPORT_DSN:-redis://:${REDIS_PASSWORD:-r_password}@${REDIS_HOST:-redis}:${REDIS_PORT:-6379}}
      MERCURE_PUBLIC_URL: https://php/.well-known/mercure # It's important to override this, using the service name
    depends_on:
      php:
        condition: service_started
      database:
        condition: service_started
      redis:
        condition: service_healthy

volumes:
  redis_data:

