{
    # Set to 'off' if using an external proxy for TLS termination
    auto_https {$CADDY_AUTO_HTTPS:off}
}

{$CADDY_EXTRA_CONFIG}

frankenphp {
	{$FRANKENPHP_CONFIG}
}

# Nostr relay WebSocket proxy
# Set RELAY_PORT to `:80` for HTTP only (behind proxy), or leave empty for HTTPS (Caddy manages certs)
{$RELAY_DOMAIN:relay.localhost}{$RELAY_PORT::80} {
	log {
		format json
	}
	encode zstd gzip
	reverse_proxy strfry:7777
}

{$SERVER_NAME:localhost}{$SERVER_PORT::80} {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
		# Redact the authorization query parameter that can be set by Mercure
		format filter {
			request>uri query {
				replace authorization REDACTED
			}
		}
	}

	root /app/public
	encode zstd br gzip

    mercure {
       transport bolt {
           path /data/mercure.db
       }

        # Publisher JWT key
        publisher_jwt {env.MERCURE_PUBLISHER_JWT_KEY} {env.MERCURE_PUBLISHER_JWT_ALG}
        # Subscriber JWT key
        subscriber_jwt {env.MERCURE_SUBSCRIBER_JWT_KEY} {env.MERCURE_SUBSCRIBER_JWT_ALG}

        anonymous
        subscriptions

        {$MERCURE_EXTRA_DIRECTIVES}
    }

	vulcain

	{$CADDY_SERVER_EXTRA_DIRECTIVES}

	# Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
	header ?Permissions-Policy "browsing-topics=()"

	@phpRoute {
		not path /.well-known/mercure*
		not file {path}
	}
	rewrite @phpRoute index.php

	@frontController path index.php
	php @frontController

	file_server
}

# Documentation:
# - To use with an external proxy (no TLS from Caddy):
#   Set CADDY_AUTO_HTTPS=off (default), ports default to :80
# - To let Caddy manage HTTPS (no external proxy):
#   Set CADDY_AUTO_HTTPS=on and set RELAY_PORT and SERVER_PORT to empty strings
# - Set RELAY_DOMAIN and SERVER_NAME to your domains (e.g., relay.example.com, example.com)
