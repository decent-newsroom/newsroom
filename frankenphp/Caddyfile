{
    # Set to 'off' if using an external proxy for TLS termination
    auto_https {$CADDY_AUTO_HTTPS:off}
}

frankenphp {
	{$FRANKENPHP_CONFIG}
}

{$CADDY_EXTRA_CONFIG}

# Nostr relay WebSocket proxy
# To enable HTTPS for relay, set RELAY_HTTPS=1 and CADDY_AUTO_HTTPS=on
{$RELAY_DOMAIN:relay.localhost}:80 {
	log {
		format json
	}
	encode zstd gzip
	reverse_proxy strfry:7777
}

{$RELAY_HTTPS:}{
	# If RELAY_HTTPS is set (e.g., ':443'), Caddy will also listen on HTTPS for the relay domain
	# Only enable if Caddy should manage certificates
	@relayHost host {$RELAY_DOMAIN:relay.localhost}
	log {
		format json
	}
	encode zstd gzip
	reverse_proxy strfry:7777
}

{$SERVER_NAME:localhost}:80 {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
		# Redact the authorization query parameter that can be set by Mercure
		format filter {
			request>uri query {
				replace authorization REDACTED
			}
		}
	}

	root /app/public
	encode zstd br gzip

    mercure {
        transport redis {
            address {env.MESSENGER_TRANSPORT_DSN}
        }

        # Publisher JWT key
        publisher_jwt {env.MERCURE_PUBLISHER_JWT_KEY} {env.MERCURE_PUBLISHER_JWT_ALG}
        # Subscriber JWT key
        subscriber_jwt {env.MERCURE_SUBSCRIBER_JWT_KEY} {env.MERCURE_SUBSCRIBER_JWT_ALG}

        anonymous
        subscriptions

        {$MERCURE_EXTRA_DIRECTIVES}
    }

	vulcain

	{$CADDY_SERVER_EXTRA_DIRECTIVES}

	# Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
	header ?Permissions-Policy "browsing-topics=()"

	@phpRoute {
		not path /.well-known/mercure*
		not file {path}
	}
	rewrite @phpRoute index.php

	@frontController path index.php
	php @frontController

	file_server
}

# Documentation:
# - To use with an external proxy, set CADDY_AUTO_HTTPS=off and only expose port 80.
# - To let Caddy manage HTTPS, set CADDY_AUTO_HTTPS=on and RELAY_HTTPS=":443".
# - Set RELAY_DOMAIN to your relay subdomain (e.g., relay.example.com).
