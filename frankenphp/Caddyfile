{
    # To disable automatic HTTPS (e.g., behind a proxy), add to your .env:
    # CADDY_EXTRA_CONFIG="{ auto_https off }"
    {$CADDY_GLOBAL_OPTIONS}
}

frankenphp {
	{$FRANKENPHP_CONFIG}
}

{$CADDY_EXTRA_CONFIG}

# Support subdomain for Unfold
{$SUPPORT_DOMAIN:support.localhost} {
    log {
        {$CADDY_SERVER_LOG_OPTIONS}
    }

    root /app/public
    encode zstd br gzip

    @phpRoute not file {path}
    rewrite @phpRoute index.php

    @frontController path index.php
    php @frontController {
        env UNFOLD_SUBDOMAIN support
    }

    file_server
}

# Main site block - handles both main domain and relay subdomain
# Configure via environment variables:
#   SERVER_NAME - main site (e.g., "example.com" or ":80" for catch-all behind proxy)
#   RELAY_DOMAIN - relay subdomain (e.g., "relay.example.com")
{$SERVER_NAME:localhost} {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
		# Redact the authorization query parameter that can be set by Mercure
		format filter {
			request>uri query {
				replace authorization REDACTED
			}
		}
	}

	# Nostr relay WebSocket proxy
	@relay host {$RELAY_DOMAIN:relay.localhost}
	handle @relay {
		encode zstd gzip
		reverse_proxy strfry:7777
	}

	# Main application
	handle {

		root /app/public
		encode zstd br gzip

		mercure {
			transport bolt {
				path /data/mercure.db
			}

			# JWT key for both publisher and subscriber
			publisher_jwt {env.MERCURE_JWT_SECRET}
			subscriber_jwt {env.MERCURE_JWT_SECRET}

			anonymous
			subscriptions

			{$MERCURE_EXTRA_DIRECTIVES}
		}

		vulcain

		{$CADDY_SERVER_EXTRA_DIRECTIVES}

		# Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
		header ?Permissions-Policy "browsing-topics=()"

		@phpRoute {
			not path /.well-known/mercure*
			not file {path}
		}
		rewrite @phpRoute index.php

		@frontController path index.php
		php @frontController

		file_server
	}
}

# Documentation:
# - To use with an external proxy (no TLS from Caddy):
#   Set CADDY_AUTO_HTTPS=off, SERVER_NAME=:80, RELAY_DOMAIN=relay.yourdomain.com
# - To let Caddy manage HTTPS (no external proxy):
#   Set CADDY_AUTO_HTTPS=on, SERVER_NAME=yourdomain.com, RELAY_DOMAIN=relay.yourdomain.com
