{
    # To disable automatic HTTPS (e.g., behind a proxy), add to your .env:
    # CADDY_EXTRA_CONFIG="{ auto_https off }"
    {$CADDY_GLOBAL_OPTIONS}
}

frankenphp {
	{$FRANKENPHP_CONFIG}
}

{$CADDY_EXTRA_CONFIG}

# Main site block - handles main domain, relay subdomain, and Unfold subdomains
# Configure via environment variables:
#   SERVER_NAME - main site address (e.g., "example.com" or ":80" for catch-all behind proxy)
#   RELAY_DOMAIN - relay subdomain (e.g., "relay.example.com")
#
# For production behind a proxy:
#   - Set SERVER_NAME=:80 (accepts all traffic from proxy)
#   - Set RELAY_DOMAIN=relay.yourdomain.com
#   - Your proxy handles TLS and routes all domains/subdomains to this container
#   - Symfony's UnfoldRequestListener handles subdomain routing
#
# For standalone production (Caddy manages HTTPS):
#   - Set SERVER_NAME=yourdomain.com (enables automatic Let's Encrypt TLS)
#   - Set RELAY_DOMAIN=relay.yourdomain.com
#   - Symfony's UnfoldRequestListener handles subdomain routing
#
# For local development:
#   - Set SERVER_NAME=localhost,*.localhost (matches both main and subdomains)
#   - Set RELAY_DOMAIN=relay.localhost
#   - Symfony's UnfoldRequestListener handles subdomain routing
{$SERVER_NAME:localhost,*.localhost} {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
		# Redact the authorization query parameter that can be set by Mercure
		format filter {
			request>uri query {
				replace authorization REDACTED
			}
		}
	}

	# Nostr relay WebSocket proxy
	@relay host {$RELAY_DOMAIN:relay.localhost}
	handle @relay {
		encode zstd gzip
		reverse_proxy strfry:7777
	}

	# Main application (handles both main site and Unfold subdomains via Symfony routing)
	handle {

		root /app/public
		encode zstd br gzip

		mercure {
			transport bolt {
				path /data/mercure.db
			}

			# JWT key for both publisher and subscriber
			publisher_jwt {env.MERCURE_JWT_SECRET}
			subscriber_jwt {env.MERCURE_JWT_SECRET}

			anonymous
			subscriptions

			{$MERCURE_EXTRA_DIRECTIVES}
		}

		vulcain

		{$CADDY_SERVER_EXTRA_DIRECTIVES}

		# Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
		header ?Permissions-Policy "browsing-topics=()"

		@phpRoute {
			not path /.well-known/mercure*
			not file {path}
		}
		rewrite @phpRoute index.php

		@frontController path index.php
		php @frontController

		file_server
	}
}

# Configuration Examples:
#
# Production behind external proxy (proxy handles TLS):
#   SERVER_NAME=:80
#   RELAY_DOMAIN=relay.yourdomain.com
#   External proxy routes all domains/subdomains â†’ this container on port 80
#
# Standalone production (Caddy manages HTTPS with Let's Encrypt):
#   SERVER_NAME=yourdomain.com
#   RELAY_DOMAIN=relay.yourdomain.com
#   Caddy automatically obtains TLS certificates
#
# Local development:
#   SERVER_NAME=localhost,*.localhost
#   RELAY_DOMAIN=relay.localhost
#   Handles both main site and Unfold subdomains locally
