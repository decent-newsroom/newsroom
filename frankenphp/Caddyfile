{
    # To disable automatic HTTPS (e.g., behind a proxy), add to your .env:
    # CADDY_EXTRA_CONFIG="{ auto_https off }"
    {$CADDY_GLOBAL_OPTIONS}
}

frankenphp {
	{$FRANKENPHP_CONFIG}
}

{$CADDY_EXTRA_CONFIG}

# Combined site block - handles main domain, relay subdomain, and Unfold subdomains
# Configure via environment variables:
#   SERVER_NAME - main site (e.g., "example.com" or ":80" for catch-all behind proxy)
#   RELAY_DOMAIN - relay subdomain (e.g., "relay.example.com")
#   UNFOLD_SERVER_NAME - Unfold subdomains (e.g., "*.localhost" for dev, omit for prod when SERVER_NAME is :80)
#
# For production behind a proxy:
#   - Set SERVER_NAME=:80 (accepts all traffic from proxy)
#   - Set RELAY_DOMAIN=relay.yourdomain.com
#   - Do NOT set UNFOLD_SERVER_NAME (it would conflict with SERVER_NAME=:80)
#   - Your proxy handles TLS and routes all subdomains to this container
#
# For local development:
#   - Set SERVER_NAME=localhost
#   - Set RELAY_DOMAIN=relay.localhost
#   - Set UNFOLD_SERVER_NAME=*.localhost (handles Unfold subdomains separately)
{$SERVER_NAME:localhost} {
	log {
		{$CADDY_SERVER_LOG_OPTIONS}
		# Redact the authorization query parameter that can be set by Mercure
		format filter {
			request>uri query {
				replace authorization REDACTED
			}
		}
	}

	# Nostr relay WebSocket proxy
	@relay host {$RELAY_DOMAIN:relay.localhost}
	handle @relay {
		encode zstd gzip
		reverse_proxy strfry:7777
	}

	# Main application (handles both main site and Unfold subdomains via Symfony routing)
	handle {

		root /app/public
		encode zstd br gzip

		mercure {
			transport bolt {
				path /data/mercure.db
			}

			# JWT key for both publisher and subscriber
			publisher_jwt {env.MERCURE_JWT_SECRET}
			subscriber_jwt {env.MERCURE_JWT_SECRET}

			anonymous
			subscriptions

			{$MERCURE_EXTRA_DIRECTIVES}
		}

		vulcain

		{$CADDY_SERVER_EXTRA_DIRECTIVES}

		# Disable Topics tracking if not enabled explicitly: https://github.com/jkarlin/topics
		header ?Permissions-Policy "browsing-topics=()"

		@phpRoute {
			not path /.well-known/mercure*
			not file {path}
		}
		rewrite @phpRoute index.php

		@frontController path index.php
		php @frontController

		file_server
	}
}

# Optional separate Unfold subdomain block for development
# Only used when UNFOLD_SERVER_NAME is set (typically "*.localhost" for local dev)
# In production behind a proxy with SERVER_NAME=:80, this should be left unset
{$UNFOLD_SERVER_NAME:} {
    log {
        {$CADDY_SERVER_LOG_OPTIONS}
    }

    root /app/public
    encode zstd br gzip

    @phpRoute not file {path}
    rewrite @phpRoute index.php

    @frontController path index.php
    php @frontController

    file_server
}

# Documentation:
# - Production behind external proxy (proxy handles TLS):
#   Set SERVER_NAME=:80, RELAY_DOMAIN=relay.yourdomain.com
#   Do NOT set UNFOLD_SERVER_NAME (would conflict with SERVER_NAME=:80)
#   External proxy routes all domains/subdomains â†’ this container
#
# - Standalone production (Caddy manages HTTPS):
#   Set SERVER_NAME=yourdomain.com, RELAY_DOMAIN=relay.yourdomain.com
#   Do NOT set UNFOLD_SERVER_NAME (Symfony handles subdomain routing)
#
# - Local development:
#   Set SERVER_NAME=localhost, RELAY_DOMAIN=relay.localhost
#   Set UNFOLD_SERVER_NAME=*.localhost (separate block for Unfold subdomains)
