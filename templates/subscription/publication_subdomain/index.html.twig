{% extends 'layout.html.twig' %}

{% block title %}Hosted Unfold | Preprint Release{% endblock %}

{% block body %}
    <div class="w-container py-4">
        <twig:Atoms:PageHeading
            heading="Hosted Unfold"
            tagline="Claim your magazine's subdomain and get production-ready Unfold hosting on Decent Newsroom"
        />

        {# Flash messages #}
        {% for message in app.flashes('success') %}
            <div class="notice success">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="notice error">{{ message }}</div>
        {% endfor %}

        {% if existingSubscription and existingSubscription.status.value == 'active' %}
            {# User already has an active subscription #}
            <div class="notice success" style="max-width: 700px; margin: 0 auto var(--spacing-4);">
                <strong>✓ Hosted Unfold is active</strong><br>
                <span style="font-size: 1.25rem; font-weight: bold;">{{ existingSubscription.subdomain }}.{{ baseDomain }}</span><br>
                {% if existingSubscription.expiresAt %}
                    Expires: {{ existingSubscription.expiresAt|date('F j, Y') }}
                {% endif %}
            </div>
            <div style="text-align: center;">
                <a href="{{ path('publication_subdomain_settings') }}" class="btn">Manage Hosting</a>
                <a href="https://{{ existingSubscription.subdomain }}.{{ baseDomain }}" class="btn btn-secondary" target="_blank">Visit Publication</a>
            </div>

            <div style="max-width: 700px; margin: var(--spacing-5) auto 0; padding: var(--spacing-3); background: var(--color-bg-secondary); border-radius: 8px;">
                <h3 style="margin-top: 0;">Preprint note</h3>
                <p style="margin-bottom: 0;">
                    Decent Newsroom is currently in its <strong>Preprint</strong> phase: infrastructure-first, publicly available, and evolving in small, deliberate releases.
                    Hosted Unfold prioritizes stable namespace allocation and reliable rendering. Publication controls and theming will expand over time.
                </p>
            </div>

        {% elseif existingSubscription and existingSubscription.status.value == 'pending' %}
            {# Pending payment #}
            <div class="notice info" style="max-width: 700px; margin: 0 auto var(--spacing-4);">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--spacing-3);">
                    <div>
                        <strong>⏳ Payment Pending</strong><br>
                        Your Hosted Unfold instance at <strong>{{ existingSubscription.subdomain }}.{{ baseDomain }}</strong> is awaiting payment confirmation.
                        <br><small style="color: var(--color-text-mid);">If you didn't pay or want to try a different name, you can cancel this pending reservation.</small>
                    </div>
                    <form action="{{ path('publication_subdomain_cancel') }}" method="post" onsubmit="return confirm('Cancel this pending subscription? You can create a new one with a different subdomain.');">
                        <input type="hidden" name="_token" value="{{ csrf_token('publication_subdomain_cancel') }}">
                        <button type="submit" class="btn btn-secondary" style="white-space: nowrap;">Cancel Pending</button>
                    </form>
                </div>
            </div>
            <div style="text-align: center;">
                <a href="{{ path('publication_subdomain_invoice') }}" class="btn btn-primary">Complete Payment</a>
            </div>

            <div style="max-width: 700px; margin: var(--spacing-5) auto 0; padding: var(--spacing-3); background: var(--color-bg-secondary); border-radius: 8px;">
                <h3 style="margin-top: 0;">What happens after payment?</h3>
                <p>
                    Once payment is confirmed by our team, we'll manually activate your hosting and configure your subdomain.
                </p>
                <p style="margin-bottom: 0;">
                    <strong>Setup time:</strong> Typically within <strong>48 hours</strong> of payment verification.
                    We'll configure DNS, proxy routing, and HTTPS certificates, then notify you when
                    <code>{{ existingSubscription.subdomain }}.{{ baseDomain }}</code> is live.
                </p>
            </div>

        {% else %}
            {# No active/pending subscription - show pricing form #}

            {# Intro #}
            <div class="d-flex flex-column align-items-center gap-3 mb-5">
                <div style="max-width: 760px; text-align: center;">
                    <p style="margin-bottom: var(--spacing-2);">
                        <strong>Hosted Unfold</strong> is managed hosting for your Unfold publication on Decent Newsroom.
                        It gives your magazine a stable address and a reader-friendly rendering layer — without servers, deployments, or certificate work.
                    </p>
                </div>
            </div>

            {# Pricing Section #}
            <div class="pricing-section">
                <div class="pricing-card" style="max-width: 640px; margin: 0 auto;">
                    <div class="pricing-details">
                        <div class="price-display">
                            <span class="price-amount">{{ priceInSats|number_format }}</span>
                            <span class="price-unit">sats</span>
                            <span class="price-period">/ year</span>
                        </div>

                        <p style="max-width: 560px; margin: var(--spacing-2) auto 0; text-align: center;">
                            Annual managed hosting license for one Unfold publication.
                        </p>

                        <div style="margin-top: var(--spacing-4);">
                            <ul class="feature-list">
                                <li>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    Dedicated subdomain
                                </li>
                                <li>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    Production-ready Unfold rendering for your magazine using the default presentation
                                </li>
                                <li>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    {{ durationDays }}-day namespace allocation
                                </li>
                                <li>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    Renew anytime before expiry
                                </li>
                            </ul>
                        </div>

                        <div style="text-align: center; margin-top: var(--spacing-4);">
                            {% if app.user %}
                                <a href="{{ path('publication_subdomain_subscribe') }}" class="btn btn-primary btn-lg">
                                    ⚡ Launch Hosted Unfold
                                </a>
                            {% else %}
                                <a href="{{ path('app_login') }}" class="btn btn-primary btn-lg">
                                    Login to Launch
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Additional Info #}
            <div style="max-width: 760px; margin: var(--spacing-5) auto; padding: var(--spacing-3); background: var(--color-bg-secondary); border-radius: 8px;">
                <h3 style="margin-top: 0;">How it works</h3>
                <ol style="padding-left: var(--spacing-4);">
                    <li>Choose your subdomain (e.g., <code>mymagazine</code>)</li>
                    <li>Select which magazine to publish (kind <code>30040</code>)</li>
                    <li>Pay <strong>{{ priceInSats|number_format }} sats</strong> via Lightning (annual)</li>
                    <li>We verify payment and activate hosting within <strong>48 hours</strong></li>
                </ol>

                <p class="mt-3" style="margin-bottom: 0;">
                    <strong>Note:</strong> You need to have a published magazine (kind <code>30040</code>) to use this feature.
                    <a href="{{ path('mag_wizard_setup') }}">Create a magazine</a> if you don't have one yet.
                </p>


                <div class="mt-5">
                    <h4 style="margin: 0 0 var(--spacing-2);">Preprint expectations</h4>
                    <ul style="margin: 0; padding-left: var(--spacing-4);">
                        <li>This release is infrastructure-first: stable URL + Unfold rendering.</li>
                        <li>Setup is currently manual (not instant) — typically completed within 48 hours.</li>
                        <li>Default presentation today; theming and publication controls will expand over time.</li>
                        <li>Pricing may change as DN matures; your current term is always honored.</li>
                    </ul>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
