{% extends 'layout.html.twig' %}

{% block body %}
<div class="w-container py-4">
    <twig:Atoms:PageHeading heading="Active Indexing" tagline="Get your content reliably indexed from your declared relays" />

    {# Flash messages for feedback #}
    {% for message in app.flashes('success') %}
        <div class="notice success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="notice error">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('info') %}
        <div class="notice info">{{ message }}</div>
    {% endfor %}

    {% if subscription and subscription.isActive %}
        <div class="notice success" style="max-width: 600px; margin: 0 auto var(--spacing-4);">
            <strong>✓ You have an active subscription!</strong><br>
            Status: <span class="badge">{{ subscription.status.label }}</span><br>
            Expires: {{ subscription.expiresAt|date('F j, Y') }}
            {% if subscription.daysRemaining is not null %}
                ({{ subscription.daysRemaining }} days remaining)
            {% endif %}
        </div>
        <div style="text-align: center;">
            <a href="{{ path('active_indexing_settings') }}" class="btn">Manage Subscription</a>
        </div>
    {% elseif subscription and subscription.status.value == 'pending' %}
        <div class="notice info" style="max-width: 600px; margin: 0 auto var(--spacing-4);">
            <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--spacing-3);">
                <div>
                    <strong>⏳ Payment Pending</strong><br>
                    Your subscription is awaiting payment confirmation.
                    <br><small style="color: var(--color-text-mid);">If you didn't pay or want to try a different plan, you can cancel this pending subscription.</small>
                </div>
                <form action="{{ path('active_indexing_cancel') }}" method="post" onsubmit="return confirm('Cancel this pending subscription? You can create a new one after cancelling.');">
                    <button type="submit" class="btn btn-secondary" style="white-space: nowrap;">Cancel Pending</button>
                </form>
            </div>
        </div>
    {% else %}
        {# Intro #}
        <div class="d-flex flex-column align-items-center gap-3 mb-5">
            <strong>Get found—even if your home relay isn’t on our default crawl list.</strong>
            <p>Active Indexing makes sure Decent Newsroom fetches your long-form content from the relays you declare.</p>
        </div>

        {# Pricing Section with Toggle #}
        <div class="pricing-section">
            <div class="pricing-toggle" role="group" aria-label="Billing period">
                <button type="button" class="toggle-btn active" data-period="monthly">Monthly</button>
                <button type="button" class="toggle-btn" data-period="yearly">
                    Yearly <span class="save-badge">Save 17%</span>
                </button>
            </div>

            <div class="pricing-card">
                {% for tier in tiers %}
                    <div class="pricing-details" data-period="{{ tier.value }}" {% if tier.value == 'yearly' %}style="display: none;"{% endif %}>
                        <div class="price-display">
                            <span class="price-amount">{{ tier.priceInSats|number_format }}</span>
                            <span class="price-unit">sats</span>
                            <span class="price-period">/ {{ tier.value == 'monthly' ? 'month' : 'year' }}</span>
                        </div>

                        <ul class="feature-list">
                            <li>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                Content fetched from your preferred relays
                            </li>
                            <li>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                Bypass quality gates - reliable indexing
                            </li>
                            <li>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                Dashboard to monitor indexing status
                            </li>
                            <li>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                Custom relay list configuration
                            </li>
                            <li>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                {{ tier.gracePeriodDays }} day grace period
                            </li>
                        </ul>

                        {% if app.user %}
                            <a href="{{ path('active_indexing_subscribe', {tier: tier.value}) }}" class="btn btn-subscribe">
                                ⚡ Subscribe Now
                            </a>
                        {% else %}
                            <button class="btn btn-subscribe" disabled>Login to Subscribe</button>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        {# NIP-65 Relay Info #}
        {% if nip65Relays|length > 0 %}
            <div class="relay-info">
                <p>Your NIP-65 relays will be used:</p>
                <div class="relay-list">
                    {% for relay in nip65Relays|slice(0, 5) %}
                        <code>{{ relay }}</code>
                    {% endfor %}
                    {% if nip65Relays|length > 5 %}
                        <span class="more-relays">+{{ nip65Relays|length - 5 }} more</span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endif %}
</div>

<style>
.active-indexing-hero {
    text-align: center;
    padding: var(--spacing-6) 0;
}

.active-indexing-hero h1 {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-2);
}

.hero-tagline {
    font-size: 1.25rem;
    color: var(--color-text-mid);
    margin: 0;
}

.pricing-section {
    max-width: 480px;
    margin: 0 auto;
}

.pricing-toggle {
    display: flex;
    justify-content: center;
    gap: var(--spacing-2);
    margin-bottom: var(--spacing-4);
    background: var(--color-bg-light);
    border-radius: 8px;
    padding: 4px;
}

.toggle-btn {
    padding: var(--spacing-2) var(--spacing-4);
    border: 1px solid transparent;
    background: transparent;
    color: var(--color-text-mid);
    cursor: pointer;
    border-radius: 6px;
    font-size: 1rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.toggle-btn.active {
    background: var(--color-primary);
    color: var(--color-text-contrast);
}

.toggle-btn:hover:not(.active) {
    color: var(--color-text);
}

.save-badge {
    font-size: 0.75rem;
    background: var(--color-accent-strong);
    color: var(--color-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
}

.pricing-card {
    background: var(--color-bg-light);
    padding: var(--spacing-5);
    text-align: center;
}

.price-display {
    margin-bottom: var(--spacing-4);
}

.price-amount {
    font-size: 3rem;
    font-weight: 700;
    color: var(--color-text);
}

.price-unit {
    font-size: 1.5rem;
    color: var(--color-secondary);
    margin-left: var(--spacing-1);
}

.price-period {
    display: block;
    font-size: 1rem;
    color: var(--color-text-mid);
    margin-top: var(--spacing-1);
}

.feature-list {
    list-style: none;
    padding: 0;
    margin: 0 0 var(--spacing-4);
    text-align: left;
}

.feature-list li {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-2);
    padding: var(--spacing-2) 0;
    color: var(--color-text);
}

.feature-list li svg {
    flex-shrink: 0;
    color: var(--color-accent);
    margin-top: 2px;
}

.btn-subscribe {
    width: 100%;
    padding: var(--spacing-3);
    font-size: 1.1rem;
}

.relay-info {
    max-width: 480px;
    margin: var(--spacing-5) auto 0;
    text-align: center;
    color: var(--color-text-mid);
    font-size: 0.875rem;
}

.relay-info p {
    margin-bottom: var(--spacing-2);
}

.relay-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--spacing-2);
}

.relay-list code {
    font-size: 0.75rem;
    padding: 2px 6px;
    background: var(--color-bg-light);
    border-radius: 4px;
}

.more-relays {
    color: var(--color-text-mid);
    font-size: 0.75rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtns = document.querySelectorAll('.toggle-btn');
    const pricingDetails = document.querySelectorAll('.pricing-details');

    toggleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const period = this.dataset.period;

            // Update active button
            toggleBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Show/hide pricing details
            pricingDetails.forEach(detail => {
                if (detail.dataset.period === period) {
                    detail.style.display = 'block';
                } else {
                    detail.style.display = 'none';
                }
            });
        });
    });
});
</script>
{% endblock %}
