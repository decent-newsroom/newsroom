{% extends 'layout.html.twig' %}

{% block body %}
<div class="w-container py-4">
    <twig:Atoms:PageHeading heading="Subscribe to Active Indexing" tagline="{{ isRenewal|default(false) ? 'Renew' : 'Subscribe' }}: {{ tier.label }}" />

    <p class="mb-4">
        <a href="{{ path('active_indexing_index') }}">← Back to Active Indexing</a>
    </p>

    <div class="d-flex gap-4">
        <div class="card" style="flex: 1;">
            <div style="text-align: center;">
                <p class="mb-3">
                    <strong>Amount: {{ amount|number_format }} sats</strong>
                </p>

                <p class="mb-4">
                    Scan the QR code or copy the invoice to pay with your Lightning wallet.
                </p>

                {# QR Code #}
                <div class="mb-4">
                    {{ qrSvg|raw }}
                </div>

                {# BOLT11 Invoice #}
                <div class="mb-3">
                    <label class="mb-1">BOLT11 Invoice:</label>
                    <div class="d-flex flex-row gap-1">
                        <input
                            type="text"
                            id="bolt11-input"
                            style="flex: 1; font-family: monospace; font-size: 12px; padding: var(--spacing-1);"
                            value="{{ bolt11 }}"
                            readonly
                            onclick="this.select()"
                        />
                        <button
                            class="btn btn-secondary"
                            type="button"
                            onclick="navigator.clipboard.writeText('{{ bolt11|e('js') }}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000)"
                        >
                            Copy
                        </button>
                    </div>
                </div>

                {# Open in Wallet #}
                <a href="lightning:{{ bolt11|upper }}" class="btn" style="width: 100%; margin-bottom: var(--spacing-3);">
                    ⚡ Open in Wallet
                </a>

                <hr style="margin: var(--spacing-4) 0;">

                {# Payment Status Check #}
                <div id="payment-status" style="margin-bottom: var(--spacing-3);"
                     data-controller="utility--payment-status"
                     data-utility--payment-status-check-url-value="{{ path('active_indexing_check_payment', {id: subscription.id}) }}"
                     data-utility--payment-status-redirect-url-value="{{ path('active_indexing_settings') }}"
                     data-utility--payment-status-interval-value="30000">
                    <button type="button" class="btn btn-secondary" data-action="utility--payment-status#check" style="margin-bottom: var(--spacing-2);">
                        Check Payment Status
                    </button>
                    <div data-utility--payment-status-target="result"></div>
                </div>

                <p class="mb-3">
                    After payment, your subscription will be activated automatically, or you can contact an admin.
                </p>

                {# Cancel Option #}
                <div style="margin-top: var(--spacing-4); padding-top: var(--spacing-3); border-top: 1px solid var(--color-border);">
                    <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-2);">Changed your mind or want to try a different plan?</p>
                    <form action="{{ path('active_indexing_cancel') }}" method="post" onsubmit="return confirm('Cancel this pending subscription? You can create a new one after.');">
                        <button type="submit" class="btn btn-secondary" style="width: 100%;">
                            Cancel Pending Subscription
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="card" style="flex: 1;">
            <h3>Subscription Details</h3>
            <dl>
                <dt>Plan</dt>
                <dd>{{ tier.label }}</dd>

                <dt>Duration</dt>
                <dd>{{ tier.durationDays }} days</dd>

                <dt>Grace Period</dt>
                <dd>{{ tier.gracePeriodDays }} days after expiry</dd>

                <dt>Price</dt>
                <dd>{{ tier.priceInSats|number_format }} sats</dd>
            </dl>

            <hr style="margin: var(--spacing-3) 0;">

            <h4>What happens next?</h4>
            <ol>
                <li>Pay the Lightning invoice</li>
                <li>Our system detects the payment</li>
                <li>Your subscription is activated</li>
                <li>We start indexing from your relays</li>
            </ol>
        </div>
    </div>
</div>

{% endblock %}
