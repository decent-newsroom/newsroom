<div {{ attributes.defaults({class: 'zap-button-component'}) }}>
    {# Zap Button - always visible #}
    <button
        type="button"
        class="btn zap-trigger {{ btnClass|default('') }}"
        data-action="live#action"
        data-live-action-param="openDialog"
        title="Send a zap"
    >
        Zap
        {% if zapSplits %}
            ({{ zapSplits|length }})
        {% endif %}
    </button>

    {# Modal Dialog #}
    {% if this.open %}
        <div class="zap-modal-overlay" data-action="click->live#action" data-live-action-param="closeDialog">
            <div class="zap-modal-content card shadow-lg" onclick="event.stopPropagation()">
                <div class="card-body">
                    {# Header #}
                    <div class="d-flex flex-row justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="m-0">Send Zap</h5>
                            {% if recipientPubkey %}
                                <small class="text-muted">to <twig:Molecules:UserFromNpub :ident="recipientPubkey"/></small>
                            {% endif %}
                        </div>
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-action="live#action"
                            data-live-action-param="closeDialog"
                        >Close</button>
                    </div>

                    {# Phase: Input #}
                    {% if this.phase == 'input' %}
                        {# Display zap splits information if configured #}
                        {% if this.zapSplits|length > 0 %}
                            <div class="alert alert-info mb-3">
                                <strong>⚡ Split Payment</strong>
                                <p class="mb-1 small">This zap will be split between {{ this.zapSplits|length }} recipients:</p>
                                <ul class="mb-0 small">
                                    {% for split in this.zapSplits %}
                                        <li>
                                            <twig:Molecules:UserFromNpub :ident="split.recipient"/>
                                            {% if split.weight %}({{ split.weight }}%){% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <form data-action="submit->live#action:prevent" data-live-action-param="createInvoice">
                            <div class="mb-3">
                                <label for="zap-amount" class="form-label">Amount (sats)</label>
                                <input
                                    type="number"
                                    id="zap-amount"
                                    class="form-control"
                                    min="1"
                                    step="1"
                                    data-model="debounce(300)|amount"
                                    value="{{ amount }}"
                                    required
                                    autofocus
                                />
                                <div class="d-flex flex-row gap-2 mt-2">
                                    <button
                                        type="button"
                                        class="btn btn-sm flex-fill"
                                        onclick="document.getElementById('zap-amount').value = 21; document.getElementById('zap-amount').dispatchEvent(new Event('input', { bubbles: true }));"
                                    >
                                        21
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm flex-fill"
                                        onclick="document.getElementById('zap-amount').value = 100; document.getElementById('zap-amount').dispatchEvent(new Event('input', { bubbles: true }));"
                                    >
                                        100
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm flex-fill"
                                        onclick="document.getElementById('zap-amount').value = 1000; document.getElementById('zap-amount').dispatchEvent(new Event('input', { bubbles: true }));"
                                    >
                                        1000
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm flex-fill"
                                        onclick="document.getElementById('zap-amount').value = 21000; document.getElementById('zap-amount').dispatchEvent(new Event('input', { bubbles: true }));"
                                    >
                                        21k
                                    </button>
                                </div>
                                <small class="form-text text-muted">Click a suggested amount or enter custom value</small>
                            </div>

                            <div class="mb-3">
                                <label for="zap-comment" class="form-label">Note (optional)</label>
                                <textarea
                                    id="zap-comment"
                                    class="form-control"
                                    rows="2"
                                    data-model="norender|comment"
                                    placeholder="Add a message..."
                                >{{ comment }}</textarea>
                            </div>

                            <button type="submit" class="btn btn-warning w-100">
                                ⚡ Create Invoice
                            </button>
                        </form>
                    {% endif %}

                    {# Phase: Loading #}
                    {% if this.phase == 'loading' %}
                        <div class="text-center py-4">
                            <div class="spinner-border text-warning mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted">Creating invoice...</p>
                        </div>
                    {% endif %}

                    {# Phase: Invoice #}
                    {% if this.phase == 'invoice' %}
                        <div class="zap-invoice">
                            {# Split payment navigation header #}
                            {% if this.invoices|length > 0 %}
                                <div class="alert alert-warning mb-3">
                                    <strong>⚡ Split Payment - Invoice {{ this.currentInvoiceIndex + 1 }} of {{ this.invoices|length }}</strong>
                                    {% set currentInvoice = this.invoices[this.currentInvoiceIndex] %}
                                    <p class="mb-1 small">
                                        Recipient: <twig:Molecules:UserFromNpub :ident="currentInvoice.recipient"/>
                                    </p>
                                    <p class="mb-0 small">
                                        Amount: <strong>{{ currentInvoice.amount }} sats</strong> ({{ currentInvoice.sharePercent }}%)
                                        {% if currentInvoice.paid %}
                                            <span class="badge bg-success ms-2">✓ Paid</span>
                                        {% endif %}
                                    </p>
                                </div>

                                {# Show error if invoice creation failed #}
                                {% if currentInvoice.error %}
                                    <div class="alert alert-danger mb-3">
                                        <strong>Error:</strong> {{ currentInvoice.error }}
                                    </div>
                                {% endif %}

                                {# Show QR code if invoice was created successfully #}
                                {% if currentInvoice.bolt11 and not currentInvoice.error %}
                                    <div class="text-center mb-3">
                                        <p class="text-success mb-2">✓ Invoice ready!</p>
                                        <p class="text-muted small">Scan with your Lightning wallet</p>
                                    </div>

                                    {# QR Code #}
                                    <div class="qr-container text-center mb-3">
                                        {{ qrSvg|raw }}
                                    </div>

                                    {# BOLT11 Invoice String #}
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">BOLT11 Invoice:</label>
                                        <div class="d-flex flex-row input-group input-group-sm">
                                            <input
                                                type="text"
                                                class="form-control font-monospace small"
                                                value="{{ bolt11 }}"
                                                readonly
                                                onclick="this.select()"
                                            />
                                            <button
                                                style="flex-shrink:0"
                                                class="btn btn-outline-secondary"
                                                type="button"
                                                onclick="navigator.clipboard.writeText('{{ bolt11|e('js') }}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000)"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </div>

                                    {# Lightning URI Link #}
                                    <div class="text-center mb-3">
                                        <a
                                            href="lightning:{{ bolt11|upper }}"
                                            class="btn btn-warning w-100"
                                        >
                                            ⚡ Open in Wallet
                                        </a>
                                    </div>

                                    {# Mark as paid button #}
{#                                    {% if not currentInvoice.paid %}#}
{#                                        <button#}
{#                                            type="button"#}
{#                                            class="btn btn-sm btn-outline-success w-100 mb-2"#}
{#                                            data-action="live#action"#}
{#                                            data-live-action-param="markAsPaid"#}
{#                                        >#}
{#                                            ✓ I've paid this invoice#}
{#                                        </button>#}
{#                                    {% endif %}#}
                                {% endif %}

                                {# Navigation buttons for multiple invoices #}
                                <div class="d-flex gap-2 mt-3">
                                    {% if this.currentInvoiceIndex > 0 %}
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary flex-fill"
                                            data-action="live#action"
                                            data-live-action-param="previousInvoice"
                                        >
                                            ← Previous
                                        </button>
                                    {% endif %}
                                    {% if this.currentInvoiceIndex < this.invoices|length - 1 %}
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-primary flex-fill"
                                            data-action="live#action"
                                            data-live-action-param="nextInvoice"
                                        >
                                            Next Invoice →
                                        </button>
                                    {% endif %}
                                </div>

                                {# Progress indicator #}
{#                                <div class="mt-3">#}
{#                                    <small class="text-muted">#}
{#                                        {% set paidCount = 0 %}#}
{#                                        {% for inv in this.invoices %}#}
{#                                            {% if inv.paid %}{% set paidCount = paidCount + 1 %}{% endif %}#}
{#                                        {% endfor %}#}
{#                                        Progress: {{ paidCount }}/{{ this.invoices|length }} invoices paid#}
{#                                    </small>#}
{#                                    <div class="progress mt-1" style="height: 4px;">#}
{#                                        <div class="progress-bar bg-success" style="width: {{ (paidCount / this.invoices|length) * 100 }}%"></div>#}
{#                                    </div>#}
{#                                </div>#}

                            {% else %}
                                {# Single invoice (no splits) #}
                                <div class="text-center mb-3">
                                    <p class="text-success mb-2">✓ Invoice ready!</p>
                                    <p class="text-muted small">Scan with your Lightning wallet</p>
                                </div>

                                {# QR Code #}
                                <div class="qr-container text-center mb-3">
                                    {{ qrSvg|raw }}
                                </div>

                                {# BOLT11 Invoice String #}
                                <div class="mb-3">
                                    <label class="form-label small text-muted">BOLT11 Invoice:</label>
                                    <div class="d-flex flex-row input-group input-group-sm">
                                        <input
                                            type="text"
                                            class="form-control font-monospace small"
                                            value="{{ bolt11 }}"
                                            readonly
                                            onclick="this.select()"
                                        />
                                        <button
                                            style="flex-shrink:0"
                                            class="btn btn-outline-secondary"
                                            type="button"
                                            onclick="navigator.clipboard.writeText('{{ bolt11|e('js') }}'); this.textContent='Copied!'; setTimeout(() => this.textContent='Copy', 2000)"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                </div>

                                {# Lightning URI Link #}
                                <div class="text-center mb-3">
                                    <a
                                        href="lightning:{{ bolt11|upper }}"
                                        class="btn btn-warning w-100"
                                    >
                                        ⚡ Open in Wallet
                                    </a>
                                    <small class="form-text text-muted d-block mt-2">
                                        Or scan the QR code above
                                    </small>
                                </div>

                                {# Back button #}
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-secondary w-100"
                                    data-action="live#action"
                                    data-live-action-param="openDialog"
                                >
                                    ← Create Another Zap
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}

                    {# Phase: Error #}
                    {% if this.phase == 'error' %}
                        <div class="alert alert-danger mb-3">
                            <strong>Error:</strong> {{ error }}
                        </div>
                        <button
                            type="button"
                            class="btn btn-outline-primary w-100"
                            data-action="live#action"
                            data-live-action-param="openDialog"
                        >
                            ← Try Again
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

