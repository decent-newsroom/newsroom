{% extends 'layout.html.twig' %}

{% import 'macros/jsonld.html.twig' as jsonld %}

{% block ogtags %}
    <meta property="og:title" content="{{ magazine.title }} - Newsroom">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ app.request.uri }}">
    {% if magazine.image %}
        <meta property="og:image" content="{{ magazine.image }}">
    {% endif %}
    {% if magazine.summary %}
        <meta property="og:description" content="{{ magazine.summary }}">
    {% endif %}
    <meta property="og:site_name" content="Newsroom">

    {# Link to machine-readable manifest #}
    <link rel="alternate" type="application/json" href="{{ url('magazine-manifest', {'mag': mag}) }}" title="Magazine Manifest">

    {# BreadcrumbList for navigation #}
    {% set breadcrumbItems = [
        {"name": "Home", "url": url('home')},
        {"name": "Newsstand", "url": url('newsstand')},
        {"name": magazine.title, "url": app.request.uri}
    ] %}
    <script type="application/ld+json">
    {{ jsonld.breadcrumbs(breadcrumbItems)|raw }}
    </script>

    {# JSON-LD Structured Data for Magazine/Periodical #}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Periodical",
        "name": {{ magazine.title|json_encode|raw }},
        {% if magazine.summary %}
        "description": {{ magazine.summary|json_encode|raw }},
        {% endif %}
        {% if magazine.image %}
        "image": {{ magazine.image|json_encode|raw }},
        {% endif %}
        "url": {{ app.request.uri|json_encode|raw }},
        {% if magazine.language %}
        "inLanguage": {{ magazine.language|json_encode|raw }},
        {% endif %}
        "publisher": {{ jsonld.organization()|raw }},
        "distribution": {
            "@type": "DataDownload",
            "encodingFormat": "application/json",
            "contentUrl": "{{ url('magazine-manifest', {'mag': mag}) }}"
        }
    }
    </script>
{% endblock %}

{% block body %}
    <twig:Organisms:MagazineHero :magazine="magazine" :mag="mag" />

    <section class="mb-5">
        {# Display chapters if available #}
        {% if chapters is defined and chapters is not empty %}
            <div class="w-container mb-5">
                <div class="mb-3">
                    <h2 class="featured-cat mb-0">Chapters</h2>
                </div>
                <div class="article-list">
                    {% for chapter in chapters %}
                        {% if chapter.fetched %}
                            {# Fetched chapter - show full card #}
                            {% set chapterEvent = chapter.event %}
                            {% set chapterSlug = '' %}
                            {% for tag in chapterEvent.tags %}
                                {% if tag[0] == 'd' %}
                                    {% set chapterSlug = tag[1] %}
                                {% endif %}
                            {% endfor %}

                            <div class="card">
                                <a href="{{ path('magazine-chapter', {mag: mag, slug: chapterSlug}) }}">
                                    {% if chapterEvent.image %}
                                        <div class="card-header">
                                            <img src="{{ chapterEvent.image }}" alt="Cover image for {{ chapterEvent.title }}">
                                        </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <h3 class="card-title">{{ chapterEvent.title }}</h3>
                                        {% if chapterEvent.summary %}
                                            <p class="lede truncate">{{ chapterEvent.summary }}</p>
                                        {% endif %}
                                    </div>
                                </a>
                            </div>
                        {% else %}
                            {# Unfetched chapter - show placeholder #}
                            <div class="card card-placeholder" data-coordinate="{{ chapter.coordinate }}">
                                <div class="card-body">
                                    <h3 class="card-title text-muted">
                                        {{ chapter.slug }}
                                    </h3>
                                    <p class="text-muted">
                                        <small>Chapter not yet fetched from relays</small>
                                    </p>
                                    <button
                                        class="btn btn-sm btn-primary fetch-chapter-btn"
                                        data-coordinate="{{ chapter.coordinate }}"
                                        data-slug="{{ chapter.slug }}"
                                        data-mag="{{ mag }}"
                                        onclick="fetchChapter(this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                        </svg>
                                        Fetch Chapter
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Display categories if available #}
        {% if categoryTags is defined and categoryTags is not empty %}
            {% for cat in categoryTags %}
                <twig:Organisms:FeaturedList :mag="mag" category="{{ cat }}" class="featured-list"/>
            {% endfor %}
        {% endif %}
    </section>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        async function fetchChapter(button) {
            const coordinate = button.dataset.coordinate;
            const slug = button.dataset.slug;
            const mag = button.dataset.mag;

            // Disable button and show loading state
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fetching...';

            try {
                const response = await fetch('/api/fetch-chapter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        coordinate: coordinate
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Reload the page to show the fetched chapter
                    window.location.reload();
                } else {
                    // Show error message
                    button.innerHTML = originalText;
                    button.disabled = false;
                    alert(result.error || 'Failed to fetch chapter. Please try again.');
                }
            } catch (error) {
                console.error('Error fetching chapter:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                alert('An error occurred while fetching the chapter. Please try again.');
            }
        }
    </script>
{% endblock %}

