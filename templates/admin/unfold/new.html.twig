{% extends 'layout.html.twig' %}

{% block title %}New Unfold Site - Admin{% endblock %}

{% block body %}
<div class="container py-4">
    <h1 class="mb-4">Create New Unfold Site</h1>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Site Configuration</h5>
                </div>
                <div class="card-body">
                    {# Form to collect data for AppData event #}
                    <form id="unfoldSiteForm">
                        {# Step 1: Subdomain #}
                        <div class="mb-4">
                            <label for="subdomain" class="form-label">Subdomain <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="subdomain"
                                       name="subdomain"
                                       placeholder="mymagazine"
                                       pattern="[a-z0-9\-]+"
                                       required>
                                <span class="input-group-text">.{{ app.request.host }}</span>
                            </div>
                            <div class="form-text">Only lowercase letters, numbers, and hyphens allowed. This will also be used as the event identifier (d-tag).</div>
                        </div>

                        {# Step 2: Magazine Selection #}
                        <div class="mb-4">
                            <label for="magazine_select" class="form-label">Select Magazine <span class="text-danger">*</span></label>
                            {% if magazines is not empty %}
                            <select class="form-select" id="magazine_select" name="magazine_select" required>
                                <option value="">-- Choose a magazine --</option>
                                {% for mag in magazines %}
                                <option value="{{ mag.coordinate }}"
                                        data-title="{{ mag.title }}"
                                        data-slug="{{ mag.slug }}">
                                    {{ mag.title }} ({{ mag.slug }})
                                </option>
                                {% endfor %}
                            </select>

                            {# Show selected coordinate as feedback #}
                            <div id="selected_coordinate_display" class="mt-2 small text-muted" style="display: none;">
                                <strong>Coordinate:</strong> <code id="selected_coordinate_text"></code>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                No magazines found. Please create and publish a magazine first.
                            </div>
                            {% endif %}
                        </div>

                        {# Step 3: Theme Selection #}
                        <div class="mb-4">
                            <label for="theme" class="form-label">Theme</label>
                            <select class="form-select" id="theme" name="theme">
                                {% for t in themes %}
                                <option value="{{ t }}" {{ t == 'casper' ? 'selected' : '' }}>{{ t|capitalize }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the theme for rendering your magazine.</div>
                        </div>

                        <hr class="my-4">

                        {# Event Preview #}
                        <div class="mb-4">
                            <label class="form-label">AppData Event Preview</label>
                            <pre id="eventPreview" class="bg-light p-3 rounded small" style="max-height: 200px; overflow-y: auto;"></pre>
                        </div>

                        {# Sign and Publish using existing Stimulus controller #}
                        <div {{ stimulus_controller('nostr--nostr-single-sign', {
                            'event': '{}',
                            'publishUrl': path('admin_unfold_publish'),
                            'redirectUrl': path('admin_unfold_index')
                        }) }} id="signerContainer">

                            <div data-nostr--nostr-single-sign-target="status"></div>

                            <div class="actions">
                                <button type="button"
                                        class="btn btn-primary"
                                        data-nostr--nostr-single-sign-target="publishButton"
                                        data-action="click->nostr--nostr-single-sign#signAndPublish"
                                        id="publishButton">
                                    <i class="bi bi-pen"></i> Sign &amp; Publish
                                </button>
                                <a href="{{ path('admin_unfold_index') }}" class="btn btn-outline-secondary">Cancel</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Help</h6>
                </div>
                <div class="card-body small">
                    <h6>What is an AppData event?</h6>
                    <p>AppData (kind 30078) is a NIP-78 event that stores application-specific data on Nostr.
                       Unfold uses it to link a magazine to a theme configuration.</p>

                    <h6>Event Structure</h6>
                    <pre class="bg-light p-2 small"><code>{
  "kind": 30078,
  "content": "Unfold App Config...",
  "tags": [
    ["d", "subdomain"],
    ["a", "30040:&lt;pubkey&gt;:&lt;slug&gt;"],
    ["theme", "casper"],
    ["alt", "Unfold App Config"]
  ]
}</code></pre>
                    <p class="small text-muted">The "a" tag contains a coordinate (kind:pubkey:identifier), not an naddr.</p>

                    <h6>Requirements</h6>
                    <ul class="mb-0">
                        <li>A Nostr signer (browser extension like nos2x or Alby)</li>
                        <li>An existing magazine (kind 30040 event)</li>
                        <li>A unique subdomain name</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const subdomainInput = document.getElementById('subdomain');
    const magazineSelect = document.getElementById('magazine_select');
    const coordinateDisplay = document.getElementById('selected_coordinate_display');
    const coordinateText = document.getElementById('selected_coordinate_text');
    const themeSelect = document.getElementById('theme');
    const previewEl = document.getElementById('eventPreview');
    const signerContainer = document.getElementById('signerContainer');

    // Current coordinate for the event
    let currentCoordinate = '';

    // Update coordinate when magazine is selected
    if (magazineSelect) {
        magazineSelect.addEventListener('change', function() {
            currentCoordinate = this.value; // Value is already the coordinate

            // Show coordinate feedback
            if (coordinateDisplay && coordinateText && currentCoordinate) {
                coordinateDisplay.style.display = 'block';
                coordinateText.textContent = currentCoordinate;
            } else if (coordinateDisplay) {
                coordinateDisplay.style.display = 'none';
            }

            updateEventPreview();
        });
    }

    function updateEventPreview() {
        const subdomain = subdomainInput.value.toLowerCase().replace(/[^a-z0-9-]/g, '').replace(/^-+|-+$/g, '') || 'my-site';
        const theme = themeSelect.value;

        // Use coordinate for 'a' tag (format: kind:pubkey:identifier)
        const aTagValue = currentCoordinate || '<kind:pubkey:identifier>';

        const event = {
            kind: 30078,
            created_at: Math.floor(Date.now() / 1000),
            tags: [
                ["d", subdomain],
                ["a", aTagValue],
                ["theme", theme],
                ["alt", "Unfold App Config"]
            ],
            content: "Unfold App Config for '" + subdomain + "'"
        };

        previewEl.textContent = JSON.stringify(event, null, 2);

        // Build the event for the signer (without created_at - signer adds it)
        const eventForSigner = {
            kind: 30078,
            tags: [
                ["d", subdomain],
                ["a", aTagValue],
                ["theme", theme],
                ["alt", "Unfold App Config"]
            ],
            content: "Unfold App Config for '" + subdomain + "'"
        };

        // Update the Stimulus controller's event value using setAttribute
        // (dataset camelCase conversion doesn't work reliably for nested namespaces)
        signerContainer.setAttribute('data-nostr--nostr-single-sign-event-value', JSON.stringify(eventForSigner));

        // Also store subdomain for the publish request
        signerContainer.dataset.unfoldSubdomain = subdomain;
    }

    // Update preview on input changes
    subdomainInput.addEventListener('input', updateEventPreview);
    themeSelect.addEventListener('change', updateEventPreview);

    // Initial preview
    updateEventPreview();

    // Override the publish button to dispatch nostr:sign event with correct data
    const publishButton = signerContainer.querySelector('[data-action*="signAndPublish"]');
    if (publishButton) {
        // Remove the original Stimulus action and handle it ourselves
        publishButton.removeAttribute('data-action');

        publishButton.addEventListener('click', function(e) {
            e.preventDefault();

            // Validate form first
            const subdomain = subdomainInput.value.trim();

            if (!subdomain) {
                alert('Please enter a subdomain.');
                subdomainInput.focus();
                return;
            }

            if (!currentCoordinate) {
                alert('Please select a magazine.');
                if (magazineSelect) magazineSelect.focus();
                return;
            }

            // Validate coordinate format (kind:pubkey:identifier)
            const coordParts = currentCoordinate.split(':');
            if (coordParts.length !== 3) {
                alert('Invalid coordinate format. Expected: kind:pubkey:identifier');
                return;
            }

            // Build the event to sign
            const eventToSign = {
                kind: 30078,
                tags: [
                    ["d", subdomain],
                    ["a", currentCoordinate],
                    ["theme", themeSelect.value],
                    ["alt", "Unfold App Config"]
                ],
                content: "Unfold App Config for '" + subdomain + "'"
            };

            // Store subdomain for the fetch interceptor
            signerContainer.dataset.unfoldSubdomain = subdomain;

            // Dispatch nostr:sign event which the controller listens for
            const signEvent = new CustomEvent('nostr:sign', {
                bubbles: true,
                detail: {
                    nostrEvent: eventToSign,
                    formData: { subdomain: subdomain }
                }
            });
            signerContainer.dispatchEvent(signEvent);
        });
    }
});

// Intercept the fetch to add subdomain to the request
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (url.includes('/admin/unfold/publish') && options && options.body) {
        try {
            const body = JSON.parse(options.body);
            const signerContainer = document.getElementById('signerContainer');
            if (signerContainer && signerContainer.dataset.unfoldSubdomain) {
                body.subdomain = signerContainer.dataset.unfoldSubdomain;
                options.body = JSON.stringify(body);
            }
        } catch (e) {
            console.error('Failed to add subdomain to request:', e);
        }
    }
    return originalFetch.apply(this, arguments);
};
</script>
{% endblock %}

{% block aside %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ path('admin_unfold_index') }}">Unfold Sites</a></li>
        <li class="breadcrumb-item active">New Site</li>
    </ol>
</nav>
{% endblock %}
